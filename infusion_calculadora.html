<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Calculadora de Infusi√≥n M√©dica</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#007bff">
  <meta name="description" content="Calculadora profesional para infusiones m√©dicas con alarmas y notificaciones">
  
  <!-- PWA Manifest -->
  <link rel="manifest" href="manifest.json">
  
  <!-- Iconos para diferentes dispositivos -->
  <link rel="icon" type="image/png" sizes="192x192" href="icon-192.png">
  <link rel="icon" type="image/png" sizes="512x512" href="icon-512.png">
  <link rel="apple-touch-icon" href="icon-192.png">
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      margin: 0;
      padding: 20px;
      min-height: 100vh;
    }
    .container {
      max-width: 500px;
      margin: 0 auto;
      background: rgba(255,255,255,0.97);
      border-radius: 18px;
      padding: 24px;
      box-shadow: 0 10px 30px rgba(102,126,234,0.10);
    }
    h2 {
      text-align: center;
      color: #4a5568;
      font-size: 2em;
      margin-bottom: 18px;
    }
    .input-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
      margin-bottom: 20px;
      padding: 16px;
      background: #f8fafc;
      border-radius: 12px;
      border: 1px solid #e2e8f0;
    }
    .input-group {
      display: flex;
      flex-direction: column;
    }
    .input-group label {
      font-weight: 600;
      color: #4a5568;
      font-size: 0.95em;
      margin-bottom: 6px;
      display: block;
      text-align: left;
    }
    .input-group input, .input-group select {
      width: 100%;
      padding: 12px;
      border-radius: 8px;
      border: 1.5px solid #e2e8f0;
      font-size: 1em;
      background: #fff;
      box-sizing: border-box;
      transition: border-color 0.2s, box-shadow 0.2s;
    }
    .input-group input:focus, .input-group select:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }
    .input-group input:disabled {
      background: #f7fafc;
      color: #a0aec0;
      cursor: not-allowed;
    }
    .btns {
      display: flex;
      gap: 10px;
      margin-bottom: 18px;
    }
    .btns button {
      flex: 1;
      padding: 12px;
      border: none;
      border-radius: 8px;
      font-size: 1.1em;
      font-weight: 700;
      cursor: pointer;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: #fff;
      transition: background 0.2s;
    }
    .btns button:last-child {
      background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%);
    }
    .tabs {
      display: flex;
      justify-content: center;
      margin-bottom: 10px;
      border-bottom: 2px solid #e2e8f0;
    }
    .tab-btn {
      padding: 8px 16px;
      border: none;
      background: #edf2f7;
      color: #4a5568;
      font-weight: 600;
      cursor: pointer;
      border-radius: 8px 8px 0 0;
      margin-right: 6px;
      border-bottom: 2px solid transparent;
      transition: all 0.2s;
    }
    .tab-btn.active {
      background: #667eea;
      color: #fff;
      border-bottom-color: #667eea;
    }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    .resultado, .avance-box {
      background: #f7fafc;
      border-radius: 10px;
      padding: 18px;
      margin-bottom: 10px;
      color: #4a5568;
      font-size: 1.08em;
      min-height: 80px;
    }
    .avance-box label {
      font-weight: 500;
      margin-bottom: 6px;
      display: block;
    }
    .grafica-progreso {
      display: flex;
      flex-direction: column;
      align-items: center;
      margin-top: 10px;
    }
    @media (max-width: 600px) {
      .container { padding: 12px; }
      .input-grid { 
        grid-template-columns: 1fr; 
        gap: 12px;
        padding: 12px;
      }
      .btns { 
        flex-direction: column; 
        gap: 8px;
      }
      .tabs { 
        flex-direction: column; 
        align-items: stretch; 
      }
      .tab-btn { 
        margin-bottom: 4px; 
        margin-right: 0; 
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>üíß Calculadora de Infusi√≥n Avanzada</h2>
    <div class="input-grid">
      <div class="input-group">
        <label>Cantidad (ml):</label>
        <input type="number" id="cantidad" placeholder="Ej: 500" step="0.1">
      </div>
      <div class="input-group">
        <label>Velocidad (ml/h):</label>
        <input type="number" id="velocidad" placeholder="Ej: 100" step="0.1" oninput="manejarVelocidadInput()">
      </div>
      <div class="input-group">
        <label>Tiempo (horas):</label>
        <input type="number" id="tiempo" placeholder="Ej: 5" step="0.1" oninput="manejarTiempoInput()">
      </div>
      <div class="input-group">
        <label>Equipo de Goteo:</label>
        <select id="equipo">
          <option value="20">Macro (20 gotas/ml)</option>
          <option value="60">Micro (60 gotas/ml)</option>
          <option value="15">Pedi√°trico (15 gotas/ml)</option>
        </select>
      </div>
    </div>
    <div class="btns">
      <button id="btnIniciar" onclick="iniciarInfusion()">Iniciar infusi√≥n</button>
      <button id="btnPausar" onclick="pausarInfusion()" style="display:none;">Pausar</button>
      <button id="btnDetener" onclick="detenerInfusion()" style="display:none;">Detener</button>
      <button onclick="calcular()">Calcular</button>
      <button onclick="limpiarCampos()">Limpiar</button>
    </div>
    <div class="tabs">
      <button class="tab-btn active" onclick="mostrarTab('resultados')">Resultados</button>
      <button class="tab-btn" onclick="mostrarTab('tiempo')">Tiempo</button>
      <button class="tab-btn" onclick="mostrarTab('cantidad')">Cantidad</button>
      <button class="tab-btn" onclick="mostrarTab('visual')">Visualizaci√≥n</button>
    </div>
    <div class="tab-content active" id="tab-resultados">
      <div class="resultado" id="resultado">
        <div style="text-align:center; color:#a0aec0;">Ingresa los datos y presiona Calcular para ver los resultados.</div>
      </div>
    </div>
    <div class="tab-content" id="tab-tiempo">
      <div class="avance-box">
        <h3 style="margin-top:0; color:#4a5568; font-size:1.1em; text-align:center;">Progreso por Tiempo</h3>
        <div id="tiempoRestanteInfo" style="color:#4a5568;"></div>
      </div>
    </div>
    <div class="tab-content" id="tab-cantidad">
      <div class="avance-box">
        <h3 style="margin-top:0; color:#4a5568; font-size:1.1em; text-align:center;">Progreso por Cantidad</h3>
        <div id="cantidadRestanteInfo" style="color:#4a5568;"></div>
      </div>
    </div>
    <div class="tab-content" id="tab-visual">
      <div class="grafica-progreso" id="graficaProgreso" style="display:none;"></div>
      <div class="visualization-container" style="max-width:220px; margin:0 auto;">
        <h3 style="margin-top:0; color:#4a5568; font-size:1.1em;">Simulaci√≥n Visual</h3>
        <div class="vasito-container" style="position:relative; height:180px; width:100px; margin:0 auto;">
          <div class="vasito" style="position:absolute; bottom:0; left:50%; transform:translateX(-50%); width:80px; height:100px; background:linear-gradient(135deg,#a8edea 0%,#fed6e3 100%); border-radius:0 0 30px 30px/0 0 40px 40px; border:3px solid #4a5568; overflow:hidden; box-shadow:0 5px 15px rgba(0,0,0,0.08);">
            <div class="liquido" style="position:absolute; bottom:0; left:0; width:100%; height:33%; background:linear-gradient(135deg,#667eea 0%,#764ba2 100%); opacity:0.85; border-radius:0 0 30px 30px/0 0 40px 40px;"></div>
          </div>
          <div id="dropArea" style="position:absolute; left:50%; top:10px; width:18px; height:90px; transform:translateX(-50%); pointer-events:none;"></div>
        </div>
        <div class="stats" style="margin-top:18px; background:#f7fafc; padding:12px; border-radius:8px;">
          <div style="text-align:center; margin-bottom:8px; color:#4a5568; font-weight:600;">Velocidad de Goteo</div>
          <div style="display:flex; justify-content:space-between; align-items:center;">
            <div style="text-align:center;">
              <div style="font-size:1.4em; font-weight:bold; color:#667eea;" id="goteosMin">--</div>
              <div style="font-size:0.9em; color:#718096;">gotas por minuto</div>
            </div>
            <div style="text-align:center;">
              <div style="font-size:1.4em; font-weight:bold; color:#667eea;" id="intervalo">--</div>
              <div style="font-size:0.9em; color:#718096;">segundos entre gotas</div>
            </div>
          </div>
        </div>
        <div class="animation-status" id="animationStatus" style="text-align:center; margin-top:8px; padding:6px; background:#e2e8f0; border-radius:6px; font-size:0.9em; color:#4a5568;">Presiona "Calcular" para ver la simulaci√≥n</div>
      </div>
    </div>
  </div>
  <script>
    // Utilidades
    function horasADisplay(horas) {
      if (isNaN(horas)) return '--:--';
      const h = Math.floor(horas);
      const m = Math.round((horas - h) * 60);
      return `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}`;
    }
    function horaFinalizacion12h(horasTotales) {
      if (isNaN(horasTotales)) return '--';
      const ahora = new Date();
      const fin = new Date(ahora.getTime() + horasTotales * 60 * 60 * 1000);
      let horas = fin.getHours();
      const minutos = fin.getMinutes();
      const ampm = horas >= 12 ? 'PM' : 'AM';
      horas = horas % 12;
      horas = horas ? horas : 12;
      return `${horas.toString().padStart(2, '0')}:${minutos.toString().padStart(2, '0')} ${ampm}`;
    }
    function renderGraficaProgreso(porcentaje) {
      const radio = 48;
      const circunferencia = 2 * Math.PI * radio;
      const progreso = Math.min(Math.max(porcentaje, 0), 100);
      const offset = circunferencia * (1 - progreso / 100);
      document.getElementById('graficaProgreso').innerHTML = `
        <svg width="120" height="120">
          <circle cx="60" cy="60" r="${radio}" stroke="#e2e8f0" stroke-width="12" fill="none" />
          <circle cx="60" cy="60" r="${radio}" stroke="#667eea" stroke-width="12" fill="none"
            stroke-dasharray="${circunferencia}" stroke-dashoffset="${offset}"
            style="transition: stroke-dashoffset 0.6s;"/>
          <text x="60" y="68" text-anchor="middle" font-size="1.6em" fill="#4a5568" font-weight="bold">${progreso.toFixed(0)}%</text>
        </svg>
        <div style="margin-top: 8px; color: #4a5568; font-size: 1em;">Progreso de infusi√≥n</div>
      `;
    }
    // Tabs
    function mostrarTab(tab) {
      const tabs = ['resultados', 'tiempo', 'cantidad', 'visual'];
      tabs.forEach(t => {
        document.getElementById('tab-' + t).classList.toggle('active', t === tab);
        document.querySelector('.tab-btn[onclick*="' + t + '"]').classList.toggle('active', t === tab);
      });
    }
    // L√≥gica de campos dependientes
    function manejarVelocidadInput() {
      const velocidadInput = document.getElementById('velocidad');
      const tiempoInput = document.getElementById('tiempo');
      if (!velocidadInput || !tiempoInput) return;
      if (velocidadInput.value.trim() !== '') {
        tiempoInput.disabled = true;
        tiempoInput.placeholder = 'Se calcular√° autom√°ticamente';
        tiempoInput.value = '';
      } else {
        tiempoInput.disabled = false;
        tiempoInput.placeholder = 'Ej: 5';
      }
    }
    function manejarTiempoInput() {
      const velocidadInput = document.getElementById('velocidad');
      const tiempoInput = document.getElementById('tiempo');
      if (!velocidadInput || !tiempoInput) return;
      if (tiempoInput.value.trim() !== '') {
        velocidadInput.disabled = true;
        velocidadInput.placeholder = 'Se calcular√° autom√°ticamente';
        velocidadInput.value = '';
      } else {
        velocidadInput.disabled = false;
        velocidadInput.placeholder = 'Ej: 100';
      }
    }
    // Variables de simulaci√≥n
    let intervaloSim = null;
    let intervaloGota = null;
    let estadoInfusion = 'detenida'; // 'en_curso', 'pausada', 'detenida'
    let tiempoTranscurrido = 0; // en horas
    let cantidadInfundida = 0; // en ml
    let datosInfusion = {};
    let tiempoInicio = null;
    let tiempoPausa = null;

    function obtenerDatosInfusion() {
      let cantidad = parseFloat(document.getElementById('cantidad').value);
      let velocidad = parseFloat(document.getElementById('velocidad').value);
      let tiempo = parseFloat(document.getElementById('tiempo').value);
      let factorGoteo = parseFloat(document.getElementById('equipo').value);
      if (!isNaN(cantidad) && !isNaN(tiempo) && isNaN(velocidad)) {
        velocidad = cantidad / tiempo;
      } else if (!isNaN(cantidad) && !isNaN(velocidad) && isNaN(tiempo)) {
        tiempo = cantidad / velocidad;
      } else if (!isNaN(velocidad) && !isNaN(tiempo) && isNaN(cantidad)) {
        cantidad = velocidad * tiempo;
      }
      if (!isNaN(cantidad) && !isNaN(velocidad) && !isNaN(tiempo) && !isNaN(factorGoteo)) {
        return { cantidad, velocidad, tiempo, factorGoteo };
      }
      return null;
    }

    function bloquearCamposInfusion(bloquear) {
      document.getElementById('cantidad').disabled = bloquear;
      document.getElementById('velocidad').disabled = bloquear;
      document.getElementById('tiempo').disabled = bloquear;
      document.getElementById('equipo').disabled = bloquear;
      document.querySelectorAll('.btns button').forEach(btn => {
        if (btn.id !== 'btnPausar' && btn.id !== 'btnDetener' && btn.id !== 'btnIniciar') {
          btn.disabled = bloquear;
        }
      });
    }

    function iniciarInfusion() {
      if (estadoInfusion === 'en_curso') return;
      const datos = obtenerDatosInfusion();
      if (!datos) {
        alert('Por favor, calcula primero la infusi√≥n con los datos correctos.');
        return;
      }
      datosInfusion = datos;
      if (estadoInfusion === 'detenida') {
        tiempoTranscurrido = 0;
        cantidadInfundida = 0;
        tiempoInicio = Date.now();
        // Resetear alertas de tiempo
        window.alerta5min = false;
        window.alerta1min = false;
      } else if (estadoInfusion === 'pausada') {
        // Ajustar tiempo de inicio para compensar la pausa
        tiempoInicio += (Date.now() - tiempoPausa);
      }
      estadoInfusion = 'en_curso';
      document.getElementById('btnIniciar').style.display = 'none';
      document.getElementById('btnPausar').style.display = '';
      document.getElementById('btnDetener').style.display = '';
      bloquearCamposInfusion(true);
      // Simulaci√≥n de avance
      if (intervaloSim) clearInterval(intervaloSim);
      intervaloSim = setInterval(actualizarSimulacion, 1000);
      // Simulaci√≥n de goteo
      iniciarAnimacionGoteo();
    }

    function pausarInfusion() {
      if (estadoInfusion !== 'en_curso') return;
      estadoInfusion = 'pausada';
      tiempoPausa = Date.now();
      if (intervaloSim) clearInterval(intervaloSim);
      detenerAnimacionGoteo();
      document.getElementById('btnIniciar').style.display = '';
      document.getElementById('btnPausar').style.display = 'none';
      document.getElementById('btnDetener').style.display = '';
      document.getElementById('btnIniciar').textContent = 'Reanudar';
    }

    function detenerInfusion() {
      estadoInfusion = 'detenida';
      if (intervaloSim) clearInterval(intervaloSim);
      detenerAnimacionGoteo();
      document.getElementById('btnIniciar').style.display = '';
      document.getElementById('btnPausar').style.display = 'none';
      document.getElementById('btnDetener').style.display = 'none';
      document.getElementById('btnIniciar').textContent = 'Iniciar infusi√≥n';
      bloquearCamposInfusion(false);
      // Restablecer avance
      tiempoTranscurrido = 0;
      cantidadInfundida = 0;
      actualizarSimulacion(true);
    }

    function actualizarSimulacion(reset = false) {
      if (!datosInfusion || !datosInfusion.cantidad || !datosInfusion.velocidad || !datosInfusion.tiempo) return;
      if (reset) {
        renderGraficaProgreso(0);
        document.getElementById('tiempoRestanteInfo').innerHTML = `
          <strong>Tiempo transcurrido:</strong> 00:00 h<br>
          <strong>Tiempo restante:</strong> ${horasADisplay(datosInfusion.tiempo)} h<br>
          <strong>Porcentaje completado:</strong> 0%<br>
          <strong>Hora estimada de finalizaci√≥n:</strong> ${horaFinalizacion12h(datosInfusion.tiempo)}
        `;
        document.getElementById('cantidadRestanteInfo').innerHTML = `
          <strong>Cantidad infundida:</strong> 0 ml<br>
          <strong>Cantidad restante:</strong> ${datosInfusion.cantidad.toFixed(2)} ml<br>
          <strong>Porcentaje completado:</strong> 0%<br>
          <strong>Hora estimada de finalizaci√≥n:</strong> ${horaFinalizacion12h(datosInfusion.tiempo)}
        `;
        return;
      }
      // Calcular tiempo transcurrido
      const ahora = Date.now();
      tiempoTranscurrido = (ahora - tiempoInicio) / (1000 * 60 * 60); // en horas
      if (tiempoTranscurrido > datosInfusion.tiempo) tiempoTranscurrido = datosInfusion.tiempo;
      cantidadInfundida = datosInfusion.velocidad * tiempoTranscurrido;
      if (cantidadInfundida > datosInfusion.cantidad) cantidadInfundida = datosInfusion.cantidad;
      // Los campos se actualizan autom√°ticamente en la interfaz
      // Porcentaje
      const porcentaje = Math.min(100, Math.max(0, (cantidadInfundida / datosInfusion.cantidad) * 100));
      const tiempoRestante = Math.max(0, datosInfusion.tiempo - tiempoTranscurrido);
      const cantidadRestante = Math.max(0, datosInfusion.cantidad - cantidadInfundida);
      // Actualizar info
      document.getElementById('tiempoRestanteInfo').innerHTML = `
        <strong>Tiempo transcurrido:</strong> ${horasADisplay(tiempoTranscurrido)} h<br>
        <strong>Tiempo restante:</strong> ${horasADisplay(tiempoRestante)} h<br>
        <strong>Porcentaje completado:</strong> ${porcentaje.toFixed(1)}%<br>
        <strong>Hora estimada de finalizaci√≥n:</strong> ${horaFinalizacion12h(tiempoRestante)}
      `;
      document.getElementById('cantidadRestanteInfo').innerHTML = `
        <strong>Cantidad infundida:</strong> ${cantidadInfundida.toFixed(2)} ml<br>
        <strong>Cantidad restante:</strong> ${cantidadRestante.toFixed(2)} ml<br>
        <strong>Porcentaje completado:</strong> ${porcentaje.toFixed(1)}%<br>
        <strong>Hora estimada de finalizaci√≥n:</strong> ${horaFinalizacion12h(tiempoRestante)}
      `;
      renderGraficaProgreso(porcentaje);
      // Alertas de tiempo restante
      const tiempoRestanteMinutos = (datosInfusion.tiempo - tiempoTranscurrido) * 60;
      
      // Alerta cuando quedan 5 minutos
      if (tiempoRestanteMinutos <= 5 && tiempoRestanteMinutos > 4.5 && !window.alerta5min) {
        window.alerta5min = true;
        mostrarAlertaTiempoRestante(5);
      }
      
      // Alerta cuando queda 1 minuto
      if (tiempoRestanteMinutos <= 1 && tiempoRestanteMinutos > 0.5 && !window.alerta1min) {
        window.alerta1min = true;
        mostrarAlertaTiempoRestante(1);
      }
      
      // Finalizar si termina
      if (tiempoTranscurrido >= datosInfusion.tiempo || cantidadInfundida >= datosInfusion.cantidad) {
        detenerInfusion();
        mostrarAlarmaFinalizacion();
      }
    }

    // Sistema de alarma para finalizaci√≥n
    function solicitarPermisoNotificaciones() {
      if ('Notification' in window && Notification.permission === 'default') {
        Notification.requestPermission();
      }
    }

    function mostrarAlarmaFinalizacion() {
      // Vibraci√≥n extendida para dispositivos m√≥viles (especialmente Android)
      if ('vibrate' in navigator) {
        // Patr√≥n de vibraci√≥n m√©dica: largo-corto-largo-corto-muy largo
        const isAndroid = /Android/i.test(navigator.userAgent);
        if (isAndroid) {
          // Patr√≥n m√°s largo y distintivo para Android
          navigator.vibrate([800, 300, 800, 300, 1200, 500, 800, 300, 1500]);
        } else {
          // Patr√≥n est√°ndar para otros dispositivos
          navigator.vibrate([500, 200, 500, 200, 500]);
        }
      }

      // Notificaci√≥n del navegador optimizada para m√≥viles
      if ('Notification' in window && Notification.permission === 'granted') {
        const ahora = new Date();
        const horaActual = ahora.toLocaleTimeString('es-ES', { 
          hour: '2-digit', 
          minute: '2-digit',
          hour12: true 
        });
        
        const notification = new Notification('üè• INFUSI√ìN COMPLETADA', {
          body: `¬°La infusi√≥n ha finalizado exitosamente a las ${horaActual}!\nüíß Cantidad: ${datosInfusion.cantidad} ml\n‚è±Ô∏è Duraci√≥n: ${horasADisplay(datosInfusion.tiempo)} h`,
          icon: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjQiIGhlaWdodD0iNjQiIHZpZXdCb3g9IjAgMCA2NCA2NCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMzIiIGN5PSIzMiIgcj0iMzIiIGZpbGw9IiM0Yjc2ODgiLz4KPHN2ZyB4PSIxNiIgeT0iMTYiIHdpZHRoPSIzMiIgaGVpZ2h0PSIzMiIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJub25lIiBzdHJva2U9IndoaXRlIiBzdHJva2Utd2lkdGg9IjIiPgo8cGF0aCBkPSJNMTIgMnY0bTAgMTJ2NGMwIDEuMS0uOSAyLTIgMkg2Yy0xLjEgMC0yLS45LTItMlY2YzAtMS4xLjktMiAyLTJoNGMxLjEgMCAyIC45IDIgMnoiLz4KPHN2ZyB4PSI4IiB5PSI4IiB3aWR0aD0iOCIgaGVpZ2h0PSI4IiB2aWV3Qm94PSIwIDAgMjQgMjQiIGZpbGw9Im5vbmUiIHN0cm9rZT0id2hpdGUiIHN0cm9rZS13aWR0aD0iMiI+CjxjaXJjbGUgY3g9IjEyIiBjeT0iMTIiIHI9IjMiLz4KPC9zdmc+Cjwvc3ZnPgo=',
          badge: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjQiIGhlaWdodD0iMjQiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMTIiIGN5PSIxMiIgcj0iMTIiIGZpbGw9IiNkYzI2MjYiLz4KPHN2ZyB4PSI2IiB5PSI2IiB3aWR0aD0iMTIiIGhlaWdodD0iMTIiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgc3Ryb2tlPSJ3aGl0ZSIgc3Ryb2tlLXdpZHRoPSIyIj4KPGNpcmNsZSBjeD0iMTIiIGN5PSIxMiIgcj0iMyIvPgo8L3N2Zz4KPC9zdmc+Cjwvc3ZnPgo=',
          requireInteraction: true,
          tag: 'infusion-complete',
          silent: false,
          timestamp: Date.now(),
          data: {
            type: 'infusion-complete',
            cantidad: datosInfusion.cantidad,
            tiempo: datosInfusion.tiempo,
            horaFin: horaActual
          },
          actions: [
            {
              action: 'view',
              title: 'üëÅÔ∏è Ver detalles',
              icon: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjQiIGhlaWdodD0iMjQiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHBhdGggZD0iTTEgMTJzNC05IDExLTkgMTEgOSAxMSA5LTQgOS0xMSA5LTExLTktMTEtOXoiIHN0cm9rZT0iIzRiNzY4OCIgc3Ryb2tlLXdpZHRoPSIyIiBmaWxsPSJub25lIi8+CjxjaXJjbGUgY3g9IjEyIiBjeT0iMTIiIHI9IjMiIHN0cm9rZT0iIzRiNzY4OCIgc3Ryb2tlLXdpZHRoPSIyIiBmaWxsPSJub25lIi8+Cjwvc3ZnPgo='
            },
            {
              action: 'dismiss',
              title: '‚úÖ Entendido',
              icon: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjQiIGhlaWdodD0iMjQiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHBhdGggZD0ibTkgMTIgMiAyIDQtNCIgc3Ryb2tlPSIjNDhiYjc4IiBzdHJva2Utd2lkdGg9IjIiIGZpbGw9Im5vbmUiLz4KPC9zdmc+Cg=='
            }
          ]
        });
        
        // Manejar acciones de la notificaci√≥n
        notification.onclick = function() {
          window.focus();
          this.close();
        };
        
        // Para dispositivos Android: mantener la notificaci√≥n m√°s tiempo
        const isAndroid = /Android/i.test(navigator.userAgent);
        const autoCloseTime = isAndroid ? 30000 : 15000; // 30s en Android, 15s en otros
        
        setTimeout(() => {
          notification.close();
        }, autoCloseTime);
      }

      // Sonido de alerta m√°s largo y distintivo para m√≥viles
      reproducirSonidoAlertaExtendido();

      // Modal visual atractivo
      mostrarModalFinalizacion();
    }

    function reproducirSonidoAlerta() {
      try {
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();
        
        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);
        
        oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
        oscillator.frequency.setValueAtTime(600, audioContext.currentTime + 0.3);
        oscillator.frequency.setValueAtTime(800, audioContext.currentTime + 0.6);
        
        gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 1);
        
        oscillator.start(audioContext.currentTime);
        oscillator.stop(audioContext.currentTime + 1);
      } catch (e) {
        console.log('Audio no disponible:', e);
      }
    }

    function reproducirSonidoAlertaExtendido() {
      try {
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        
        // Crear una secuencia de tonos m√°s larga y distintiva
        const crearTono = (frecuencia, inicio, duracion, volumen = 0.4) => {
          const oscillator = audioContext.createOscillator();
          const gainNode = audioContext.createGain();
          
          oscillator.connect(gainNode);
          gainNode.connect(audioContext.destination);
          
          oscillator.frequency.setValueAtTime(frecuencia, audioContext.currentTime + inicio);
          gainNode.gain.setValueAtTime(0, audioContext.currentTime + inicio);
          gainNode.gain.linearRampToValueAtTime(volumen, audioContext.currentTime + inicio + 0.1);
          gainNode.gain.linearRampToValueAtTime(0, audioContext.currentTime + inicio + duracion - 0.1);
          
          oscillator.start(audioContext.currentTime + inicio);
          oscillator.stop(audioContext.currentTime + inicio + duracion);
        };
        
        // Secuencia de alarma m√©dica distintiva (similar a equipos hospitalarios)
        crearTono(800, 0, 0.4, 0.5);     // Primer tono alto
        crearTono(600, 0.5, 0.4, 0.5);   // Segundo tono medio
        crearTono(800, 1.0, 0.4, 0.5);   // Tercer tono alto
        crearTono(1000, 1.5, 0.6, 0.6);  // Cuarto tono muy alto y m√°s largo
        
        // Pausa y repetici√≥n para mayor notoriedad
        crearTono(800, 2.5, 0.4, 0.5);
        crearTono(600, 3.0, 0.4, 0.5);
        crearTono(1000, 3.5, 0.8, 0.6);  // Tono final m√°s largo
        
      } catch (e) {
        console.log('Audio no disponible:', e);
        // Fallback: intentar reproducir sonido del sistema
        try {
          // Para algunos navegadores m√≥viles
          const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSuBzvLZiTYIG2m98OScTgwOUarm7blmGgU7k9n1unEiBC13yO/eizEIHWq+8+OWT');
          audio.play().catch(() => {});
        } catch (e2) {
          console.log('Audio fallback no disponible:', e2);
        }
      }
    }

    function mostrarModalFinalizacion() {
      const modal = document.createElement('div');
      modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.8);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 10000;
        animation: fadeIn 0.3s ease-in;
      `;
      
      const modalContent = document.createElement('div');
      modalContent.style.cssText = `
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 40px;
        border-radius: 20px;
        text-align: center;
        max-width: 400px;
        width: 90%;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        animation: slideIn 0.4s ease-out;
      `;
      
      const ahora = new Date();
      const horaActual = ahora.toLocaleTimeString('es-ES', { 
        hour: '2-digit', 
        minute: '2-digit',
        hour12: true 
      });
      
      modalContent.innerHTML = `
        <div style="font-size: 4em; margin-bottom: 20px; animation: bounce 1s infinite;">üè•</div>
        <h2 style="margin: 0 0 15px 0; font-size: 1.8em;">¬°Infusi√≥n Completada!</h2>
        <p style="margin: 0 0 20px 0; font-size: 1.1em; opacity: 0.9;">La infusi√≥n ha finalizado exitosamente</p>
        <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 10px; margin-bottom: 25px;">
          <p style="margin: 0; font-size: 1em;">üìÖ Finalizada a las: <strong>${horaActual}</strong></p>
          <p style="margin: 5px 0 0 0; font-size: 0.9em;">üíß Cantidad: <strong>${datosInfusion.cantidad} ml</strong></p>
        </div>
        <button onclick="cerrarModalFinalizacion()" style="
          background: rgba(255,255,255,0.2);
          border: 2px solid white;
          color: white;
          padding: 12px 30px;
          border-radius: 25px;
          font-size: 1.1em;
          font-weight: bold;
          cursor: pointer;
          transition: all 0.3s;
        " onmouseover="this.style.background='rgba(255,255,255,0.3)'" onmouseout="this.style.background='rgba(255,255,255,0.2)'">Entendido</button>
      `;
      
      modal.appendChild(modalContent);
      document.body.appendChild(modal);
      
      // Agregar estilos de animaci√≥n
      const style = document.createElement('style');
      style.textContent = `
        @keyframes fadeIn {
          from { opacity: 0; }
          to { opacity: 1; }
        }
        @keyframes slideIn {
          from { transform: translateY(-50px) scale(0.8); opacity: 0; }
          to { transform: translateY(0) scale(1); opacity: 1; }
        }
        @keyframes bounce {
          0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
          40% { transform: translateY(-10px); }
          60% { transform: translateY(-5px); }
        }
      `;
      document.head.appendChild(style);
      
      // Funci√≥n global para cerrar el modal
      window.cerrarModalFinalizacion = function() {
        modal.style.animation = 'fadeOut 0.3s ease-out';
        setTimeout(() => {
          document.body.removeChild(modal);
          document.head.removeChild(style);
          delete window.cerrarModalFinalizacion;
        }, 300);
      };
      
      // Cerrar con Escape
      const handleEscape = (e) => {
        if (e.key === 'Escape') {
          window.cerrarModalFinalizacion();
          document.removeEventListener('keydown', handleEscape);
        }
      };
      document.addEventListener('keydown', handleEscape);
     }

    function mostrarAlertaTiempoRestante(minutos) {
      // Vibraci√≥n suave para dispositivos m√≥viles
      if ('vibrate' in navigator) {
        navigator.vibrate([200, 100, 200]);
      }

      // Notificaci√≥n del navegador
      if ('Notification' in window && Notification.permission === 'granted') {
        const notification = new Notification(`‚è∞ ${minutos} minuto${minutos > 1 ? 's' : ''} restante${minutos > 1 ? 's' : ''}`, {
          body: `La infusi√≥n terminar√° en aproximadamente ${minutos} minuto${minutos > 1 ? 's' : ''}`,
          icon: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjQiIGhlaWdodD0iNjQiIHZpZXdCb3g9IjAgMCA2NCA2NCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMzIiIGN5PSIzMiIgcj0iMzIiIGZpbGw9IiNmNTk3MzEiLz4KPHN2ZyB4PSIxNiIgeT0iMTYiIHdpZHRoPSIzMiIgaGVpZ2h0PSIzMiIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJub25lIiBzdHJva2U9IndoaXRlIiBzdHJva2Utd2lkdGg9IjIiPgo8Y2lyY2xlIGN4PSIxMiIgY3k9IjEyIiByPSIxMCIvPgo8cG9seWxpbmUgcG9pbnRzPSIxMiw2IDEyLDEyIDE2LDE0Ii8+Cjwvc3ZnPgo8L3N2Zz4K',
          tag: 'infusion-warning',
          requireInteraction: false
        });
        
        // Auto-cerrar despu√©s de 5 segundos
        setTimeout(() => {
          notification.close();
        }, 5000);
      }

      // Sonido de alerta suave
      try {
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();
        
        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);
        
        oscillator.frequency.setValueAtTime(600, audioContext.currentTime);
        gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
        
        oscillator.start(audioContext.currentTime);
        oscillator.stop(audioContext.currentTime + 0.5);
      } catch (e) {
        console.log('Audio no disponible:', e);
      }

      // Toast notification visual
      const toast = document.createElement('div');
      toast.style.cssText = `
        position: fixed;
        top: 80px;
        right: 20px;
        background: linear-gradient(135deg, #f59731 0%, #f56565 100%);
        color: white;
        padding: 12px 16px;
        border-radius: 10px;
        font-size: 0.9em;
        font-weight: 600;
        z-index: 9999;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        animation: slideInRight 0.3s ease-out;
        max-width: 280px;
      `;
      
      toast.innerHTML = `
        <div style="display: flex; align-items: center; gap: 8px;">
          <span style="font-size: 1.2em;">‚è∞</span>
          <div>
            <div style="font-weight: bold;">${minutos} min restante${minutos > 1 ? 's' : ''}</div>
            <div style="font-size: 0.8em; opacity: 0.9;">La infusi√≥n est√° por terminar</div>
          </div>
        </div>
      `;
      
      document.body.appendChild(toast);
      
      // Agregar animaci√≥n
      const toastStyle = document.createElement('style');
      toastStyle.textContent = `
        @keyframes slideInRight {
          from { transform: translateX(100%); opacity: 0; }
          to { transform: translateX(0); opacity: 1; }
        }
        @keyframes slideOutRight {
          from { transform: translateX(0); opacity: 1; }
          to { transform: translateX(100%); opacity: 0; }
        }
      `;
      document.head.appendChild(toastStyle);
      
      // Auto-remover despu√©s de 4 segundos
      setTimeout(() => {
        toast.style.animation = 'slideOutRight 0.3s ease-in';
        setTimeout(() => {
          if (document.body.contains(toast)) {
            document.body.removeChild(toast);
          }
          if (document.head.contains(toastStyle)) {
            document.head.removeChild(toastStyle);
          }
        }, 300);
      }, 4000);
    }

    // Animaci√≥n de goteo
    function iniciarAnimacionGoteo() {
      detenerAnimacionGoteo();
      if (!datosInfusion || !datosInfusion.velocidad || !datosInfusion.factorGoteo) return;
      const gotasPorMin = (datosInfusion.velocidad * datosInfusion.factorGoteo) / 60;
      const intervalo = 60000 / gotasPorMin; // ms entre gotas
      const grafica = document.getElementById('graficaProgreso');
      function animarGota() {
        if (estadoInfusion !== 'en_curso') return;
        const gota = document.createElement('div');
        gota.style.width = '18px';
        gota.style.height = '18px';
        gota.style.borderRadius = '50%';
        gota.style.background = '#667eea';
        gota.style.margin = '0 auto 8px auto';
        gota.style.opacity = '0.85';
        gota.style.transition = 'transform 0.7s linear, opacity 0.7s linear';
        grafica.appendChild(gota);
        setTimeout(() => {
          gota.style.transform = 'translateY(40px) scale(0.7)';
          gota.style.opacity = '0';
        }, 10);
        setTimeout(() => {
          if (grafica.contains(gota)) grafica.removeChild(gota);
        }, 800);
      }
      intervaloGota = setInterval(animarGota, intervalo);
      animarGota(); // Primera gota inmediata
    }
    function detenerAnimacionGoteo() {
      if (intervaloGota) clearInterval(intervaloGota);
      intervaloGota = null;
    }
    // --- Animaci√≥n de gotas en vasito ---
    let dropInterval = null;
    let dropCounter = 0;
    function detenerAnimacion() {
      if (dropInterval) {
        clearInterval(dropInterval);
        dropInterval = null;
      }
      // Limpiar gotas existentes
      const dropArea = document.getElementById('dropArea');
      if (dropArea) {
        dropArea.innerHTML = '';
      }
      document.getElementById('animationStatus').textContent = 'Presiona "Calcular" para ver la simulaci√≥n';
    }
    function crearGotaVasito() {
      const dropArea = document.getElementById('dropArea');
      if (!dropArea) return;
      
      // Limitar el n√∫mero de gotas simult√°neas
      const gotasExistentes = dropArea.children.length;
      if (gotasExistentes >= 3) {
        return; // No crear m√°s gotas si ya hay 3 o m√°s
      }
      
      const drop = document.createElement('div');
      drop.className = 'drop-vasito';
      drop.style.position = 'absolute';
      drop.style.left = '0';
      drop.style.top = '0';
      drop.style.width = '16px';
      drop.style.height = '16px';
      drop.style.borderRadius = '50% 50% 60% 60%/60% 60% 80% 80%';
      drop.style.background = 'linear-gradient(135deg,#667eea 0%,#764ba2 100%)';
      drop.style.opacity = '0.9';
      drop.style.boxShadow = '0 2px 6px rgba(102,126,234,0.4)';
      drop.style.transform = 'translateY(0) scale(1)';
      drop.style.transition = 'transform 0.8s ease-in, opacity 0.8s linear';
      drop.style.zIndex = '10';
      
      dropArea.appendChild(drop);
      
      // Animar la ca√≠da
      setTimeout(() => {
        drop.style.transform = 'translateY(75px) scale(0.6)';
        drop.style.opacity = '0';
      }, 50);
      
      // Remover la gota despu√©s de la animaci√≥n
      setTimeout(() => {
        if (dropArea.contains(drop)) {
          dropArea.removeChild(drop);
        }
      }, 900);
    }
    function iniciarAnimacion(goteosMinuto) {
      detenerAnimacion();
      if (goteosMinuto > 0) {
        const intervalMs = Math.max(500, (60 / goteosMinuto) * 1000); // M√≠nimo 0.5 segundos entre gotas
        
        // Crear primera gota despu√©s de un peque√±o delay
        setTimeout(() => {
          if (dropInterval) { // Solo si la animaci√≥n sigue activa
            crearGotaVasito();
          }
        }, 300);
        
        dropInterval = setInterval(() => {
          crearGotaVasito();
        }, intervalMs);
        
        const segundosEntreGotas = (intervalMs/1000).toFixed(1);
        document.getElementById('animationStatus').textContent = `Simulaci√≥n activa: 1 gota cada ${segundosEntreGotas} segundos`;
      }
    }
    // Calcular
    function calcular() {
      let cantidad = parseFloat(document.getElementById('cantidad').value);
      let velocidad = parseFloat(document.getElementById('velocidad').value);
      let tiempo = parseFloat(document.getElementById('tiempo').value);
      let factorGoteo = parseFloat(document.getElementById('equipo').value);
      let resultado = '';
      let esValido = false;
      // L√≥gica de c√°lculo
      if (!isNaN(cantidad) && !isNaN(tiempo) && isNaN(velocidad)) {
        velocidad = cantidad / tiempo;
      } else if (!isNaN(cantidad) && !isNaN(velocidad) && isNaN(tiempo)) {
        tiempo = cantidad / velocidad;
      } else if (!isNaN(velocidad) && !isNaN(tiempo) && isNaN(cantidad)) {
        cantidad = velocidad * tiempo;
      }
      // Mostrar resultados
      if (!isNaN(cantidad) && !isNaN(velocidad) && !isNaN(tiempo)) {
        let gtt = (velocidad * factorGoteo) / 60;
        let intervaloGota = 60 / gtt;
        resultado = `
          <strong>üìä Resultados:</strong><br>
          üì¶ Cantidad: <strong>${cantidad.toFixed(2)} ml</strong><br>
          üí® Velocidad: <strong>${velocidad.toFixed(2)} ml/h</strong><br>
          ‚è±Ô∏è Tiempo: <strong>${horasADisplay(tiempo)} h</strong><br>
          üíß Goteo: <strong>${gtt.toFixed(1)} gotas/min</strong><br>
          ‚è∞ Intervalo: <strong>${intervaloGota.toFixed(1)} seg/gota</strong><br>
          üîß Equipo: <strong>${factorGoteo} gotas/ml</strong><br>
          üïí Finaliza: <strong>${horaFinalizacion12h(tiempo)}</strong>
        `;
        esValido = true;
      } else {
        resultado = '<span style="color:#ee5a52">Por favor, completa dos de los tres campos principales y selecciona el equipo de goteo.</span>';
      }
      document.getElementById('resultado').innerHTML = resultado;
      // Los campos de avance se actualizan autom√°ticamente
      // Avance inicial en pesta√±as
      if (esValido) {
        // Tiempo
        document.getElementById('tiempoRestanteInfo').innerHTML = `
          <strong>Tiempo transcurrido:</strong> 00:00 h<br>
          <strong>Tiempo restante:</strong> ${horasADisplay(tiempo)} h<br>
          <strong>Porcentaje completado:</strong> 0%<br>
          <strong>Hora estimada de finalizaci√≥n:</strong> ${horaFinalizacion12h(tiempo)}
        `;
        // Cantidad
        document.getElementById('cantidadRestanteInfo').innerHTML = `
          <strong>Cantidad infundida:</strong> 0 ml<br>
          <strong>Cantidad restante:</strong> ${cantidad.toFixed(2)} ml<br>
          <strong>Porcentaje completado:</strong> 0%<br>
          <strong>Hora estimada de finalizaci√≥n:</strong> ${horaFinalizacion12h(tiempo)}
        `;
        renderGraficaProgreso(0);
        // Actualizar stats de visualizaci√≥n
        let gtt = (velocidad * factorGoteo) / 60;
        let intervaloGota = 60 / gtt;
        actualizarStats(gtt, intervaloGota);
        
        // Iniciar animaci√≥n de goteo en el vasito
        iniciarAnimacion(gtt);
      } else {
        document.getElementById('tiempoRestanteInfo').innerHTML = '';
        document.getElementById('cantidadRestanteInfo').innerHTML = '';
        renderGraficaProgreso(0);
        
        // Resetear stats de visualizaci√≥n
        actualizarStats('--', '--');
        detenerAnimacion();
      }
    }
    // Las funciones de avance manual se han eliminado para simplificar la interfaz
    // Funci√≥n para actualizar estad√≠sticas de visualizaci√≥n
    function actualizarStats(goteosMin, intervalo) {
      document.getElementById('goteosMin').textContent = 
        goteosMin === '--' ? '--' : goteosMin.toFixed(1);
      document.getElementById('intervalo').textContent = 
        intervalo === '--' ? '--' : intervalo.toFixed(1);
    }
    
    // Limpiar
    function limpiarCampos() {
      document.getElementById('cantidad').value = '';
      document.getElementById('velocidad').value = '';
      document.getElementById('tiempo').value = '';
      document.getElementById('equipo').selectedIndex = 0;
      document.getElementById('velocidad').disabled = false;
      document.getElementById('tiempo').disabled = false;
      document.getElementById('velocidad').placeholder = 'Ej: 100';
      document.getElementById('tiempo').placeholder = 'Ej: 5';
      document.getElementById('resultado').innerHTML = '<div style="text-align:center; color:#a0aec0;">Ingresa los datos y presiona Calcular para ver los resultados.</div>';
      // Los campos de progreso se actualizan autom√°ticamente
      document.getElementById('tiempoRestanteInfo').innerHTML = '';
      document.getElementById('cantidadRestanteInfo').innerHTML = '';
      renderGraficaProgreso(0);
      actualizarStats('--', '--');
      detenerInfusion();
      detenerAnimacion();
    }
    // Inicializaci√≥n
    document.addEventListener('DOMContentLoaded', function() {
      mostrarTab('resultados');
      manejarVelocidadInput();
      manejarTiempoInput();
      renderGraficaProgreso(0);
      
      // Solicitar permisos de notificaci√≥n al cargar
      setTimeout(() => {
        solicitarPermisoNotificaciones();
      }, 2000);
      
      // Agregar indicador de notificaciones
      agregarIndicadorNotificaciones();
    });
    
    function agregarIndicadorNotificaciones() {
      const container = document.querySelector('.container');
      const indicador = document.createElement('div');
      indicador.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: rgba(102, 126, 234, 0.9);
        color: white;
        padding: 8px 12px;
        border-radius: 20px;
        font-size: 0.85em;
        cursor: pointer;
        z-index: 1000;
        transition: all 0.3s;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      `;
      
      function actualizarIndicador() {
        if ('Notification' in window) {
          if (Notification.permission === 'granted') {
            indicador.innerHTML = 'üîî Alarmas activadas';
            indicador.style.background = 'rgba(72, 187, 120, 0.9)';
          } else if (Notification.permission === 'denied') {
            indicador.innerHTML = 'üîï Alarmas bloqueadas';
            indicador.style.background = 'rgba(245, 101, 101, 0.9)';
          } else {
            indicador.innerHTML = 'üîî Activar alarmas';
            indicador.style.background = 'rgba(102, 126, 234, 0.9)';
          }
        } else {
          indicador.innerHTML = 'üì± Solo vibraci√≥n';
          indicador.style.background = 'rgba(128, 128, 128, 0.9)';
        }
      }
      
      indicador.onclick = function() {
        if ('Notification' in window && Notification.permission !== 'granted') {
          Notification.requestPermission().then(permission => {
            actualizarIndicador();
            if (permission === 'granted') {
              // Mostrar notificaci√≥n de prueba
              new Notification('üè• Alarmas Activadas', {
                body: 'Recibir√°s notificaciones cuando termine la infusi√≥n',
                icon: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjQiIGhlaWdodD0iNjQiIHZpZXdCb3g9IjAgMCA2NCA2NCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMzIiIGN5PSIzMiIgcj0iMzIiIGZpbGw9IiM0ODkzZjQiLz4KPHN2ZyB4PSIxNiIgeT0iMTYiIHdpZHRoPSIzMiIgaGVpZ2h0PSIzMiIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJub25lIiBzdHJva2U9IndoaXRlIiBzdHJva2Utd2lkdGg9IjIiPgo8cGF0aCBkPSJtOSAxMiAyIDIgNC00Ii8+CjxwYXRoIGQ9Im0yMSAyLTEgMWEyIDIgMCAwIDEtMiAySDRhMiAyIDAgMCAxLTItMlYyYTIgMiAwIDAgMSAyLTJoMTRhMiAyIDAgMCAxIDIgMnoiLz4KPC9zdmc+Cjwvc3ZnPgo='
              });
            }
          });
        }
      };
      
      actualizarIndicador();
      document.body.appendChild(indicador);
      
      // Ocultar despu√©s de 10 segundos si ya est√°n activadas
      if (Notification.permission === 'granted') {
        setTimeout(() => {
          indicador.style.opacity = '0.3';
          indicador.style.transform = 'scale(0.8)';
        }, 10000);
      }
    }
  </script>

    <!-- PWA Service Worker Registration -->
    <script>
      // Registrar Service Worker
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
          navigator.serviceWorker.register('./sw.js')
            .then(registration => {
              console.log('SW registrado con √©xito:', registration.scope);
              
              // Guardar referencia para notificaciones programadas
              window.swRegistration = registration;
            })
            .catch(error => {
              console.log('Error al registrar SW:', error);
            });
        });
      }

      // Detectar si la app est√° instalada como PWA
      let deferredPrompt;
      const installButton = document.createElement('button');
      installButton.textContent = 'üì± Instalar App';
      installButton.style.cssText = `
        position: fixed;
        bottom: 20px;
        right: 20px;
        background: #007bff;
        color: white;
        border: none;
        padding: 12px 16px;
        border-radius: 25px;
        font-size: 14px;
        cursor: pointer;
        box-shadow: 0 4px 12px rgba(0,123,255,0.3);
        z-index: 1000;
        display: none;
        transition: all 0.3s ease;
      `;

      window.addEventListener('beforeinstallprompt', (e) => {
        e.preventDefault();
        deferredPrompt = e;
        installButton.style.display = 'block';
        document.body.appendChild(installButton);
      });

      installButton.addEventListener('click', async () => {
        if (deferredPrompt) {
          deferredPrompt.prompt();
          const { outcome } = await deferredPrompt.userChoice;
          if (outcome === 'accepted') {
            console.log('PWA instalada');
            installButton.style.display = 'none';
          }
          deferredPrompt = null;
        }
      });

      // Detectar cuando la app se instala
      window.addEventListener('appinstalled', () => {
        console.log('PWA instalada exitosamente');
        installButton.style.display = 'none';
        
        // Mostrar mensaje de bienvenida
        setTimeout(() => {
          if (Notification.permission === 'granted') {
            new Notification('üéâ ¬°App Instalada!', {
              body: 'Calculadora de Infusi√≥n instalada correctamente. Ahora recibir√°s notificaciones incluso con el navegador cerrado.',
              icon: 'icon-192.png'
            });
          }
        }, 1000);
      });

      // Funci√≥n mejorada para notificaciones PWA
      function enviarNotificacionPWA(titulo, mensaje, delay = 0) {
        if ('serviceWorker' in navigator && window.swRegistration) {
          // Enviar mensaje al Service Worker para programar notificaci√≥n
          navigator.serviceWorker.ready.then(registration => {
            if (registration.active) {
              registration.active.postMessage({
                type: 'SCHEDULE_NOTIFICATION',
                title: titulo,
                body: mensaje,
                delay: delay
              });
            }
          });
        }
      }

      // Mejorar la funci√≥n de alarma de finalizaci√≥n para PWA
      const mostrarAlarmaFinalizacionOriginal = mostrarAlarmaFinalizacion;
      mostrarAlarmaFinalizacion = function() {
        // Ejecutar la funci√≥n original
        mostrarAlarmaFinalizacionOriginal();
        
        // Agregar notificaci√≥n PWA persistente
        const ahora = new Date();
        const tiempoFormateado = ahora.toLocaleTimeString('es-ES', {
          hour: '2-digit',
          minute: '2-digit'
        });
        
        enviarNotificacionPWA(
          'üè• INFUSI√ìN COMPLETADA',
          `Finalizada a las ${tiempoFormateado}. Cantidad: ${cantidad}ml, Duraci√≥n: ${Math.round(tiempo)}min`
        );
      };

      // Mejorar alertas de tiempo restante para PWA
      const mostrarAlertaTiempoRestanteOriginal = mostrarAlertaTiempoRestante;
      mostrarAlertaTiempoRestante = function(minutosRestantes) {
        // Ejecutar la funci√≥n original
        mostrarAlertaTiempoRestanteOriginal(minutosRestantes);
        
        // Agregar notificaci√≥n PWA
        enviarNotificacionPWA(
          `‚è∞ ${minutosRestantes} MINUTOS RESTANTES`,
          `La infusi√≥n finalizar√° en ${minutosRestantes} minuto${minutosRestantes > 1 ? 's' : ''}. Prep√°rate para el cambio.`
        );
      };
    </script>
  </body>
</html>